name: Compile and Run apgluxe Search from GitLab (Grouped Execution)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      search_rule:
        description: 'Conway''s Life Rule (e.g., b3s23)'
        required: true
        default: 'b3s23'
      symmetry:
        description: 'Symmetry configuration (e.g., C1, D2_+1)'
        required: true
        default: 'C1'
      key:
        description: 'Your payosha256 key for uploading results (optional)'
        required: false
        default: ''
      haul_size:
        description: 'Number of soups per upload (-n)'
        required: true
        default: '20000000'
      threads:
        description: 'Number of threads to use (-p)'
        required: true
        default: '2'

jobs:
  search:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Git and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential

      - name: Clone apgluxe Repository from GitLab
        run: |
          git clone https://gitlab.com/apgoucher/apgmera.git
          # Capture the directory name for demonstration (though we won't reuse it this way)
          # In a standard checkout, the directory name is the repo name.
          RUN_DIR=$(pwd)/apgmera
          echo "::set-output name=source_dir::$RUN_DIR"

      - name: Compile apgluxe
        run: |
          cd apgmera
          ./recompile.sh
        
      - name: Verify Compilation Output
        run: |
          cd apgmera
          if [ -f apgluxe ]; then
            echo "Compilation successful. Checking configuration:"
            ./apgluxe --version
          else
            echo "Compilation failed. apgluxe executable not found."
            exit 1
          fi

      - name: Construct apgluxe Run Command
        id: build_command
        run: |
          COMMAND="./apgluxe"
          
          # 1. Add rule and symmetry
          RULE_INPUT="${{ github.event.inputs.search_rule }}"
          SYMMETRY_INPUT="${{ github.event.inputs.symmetry }}"
          COMMAND+=" --rule ${RULE_INPUT:-b3s23}"
          COMMAND+=" --symmetry ${SYMMETRY_INPUT:-C1}"

          # 2. Add haul size (-n)
          COMMAND+=" -n ${{ github.event.inputs.haul_size || '20000000' }}"
          
          # 3. Add threads (-p)
          COMMAND+=" -p ${{ github.event.inputs.threads || '2' }}"

          # 4. Add key (-k) if provided
          KEY="${{ github.event.inputs.key }}"
          if [[ ! -z "$KEY" ]]; then
            COMMAND+=" -k $KEY"
          fi

          # 5. Safety flags for automated testing:
          COMMAND+=" -t 1" # Disable uploading
          COMMAND+=" -i 1"  # Run for 1 haul and exit
          
          echo "::set-output name=command::$COMMAND"

      - name: Run apgluxe Search (Grouped Execution)
        run: |
          # We execute the CD and the run command together in one shell block
          # so the 'cd' persists for the duration of this single command execution.
          cd apgmera
          echo "Current directory check: $(pwd)" # This will show /home/runner/work/.../apgmera
          
          echo "Executing command: ${{ steps.build_command.outputs.command }}"
          ${{ steps.build_command.outputs.command }}
