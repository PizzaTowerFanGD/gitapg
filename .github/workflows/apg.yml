name: Compile and Run apgluxe Search from GitLab (Rule Passed to Build)

on:
  workflow_dispatch:
    inputs:
      search_rule:
        description: 'Conway''s Life Rule (e.g., b3s23)'
        required: true
        default: 'b3s23'
      symmetry:
        description: 'Symmetry configuration (e.g., C1, D2_+1)'
        required: true
        default: 'C1'
      key:
        description: 'Your payosha256 key for uploading results (optional)'
        required: false
        default: ''
      haul_size:
        description: 'Number of soups per upload (-n)'
        required: true
        default: '20000000'
      threads:
        description: 'Number of threads to use (-p)'
        required: true
        default: '2'

jobs:
  search:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Git and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential

      - name: Clone apgluxe Repository from GitLab
        run: |
          git clone https://gitlab.com/apgoucher/apgmera.git
          
      # --- Compilation Steps ---
      - name: Compile apgluxe with Specific Rule/Symmetry Context
        id: compile
        working-directory: ./apgmera
        run: |
          RULE="${{ github.event.inputs.search_rule || 'b3s23' }}"
          SYMM="${{ github.event.inputs.symmetry || 'C1' }}"
          
          # Assuming recompile.sh accepts the rule and symmetry as positional or specific flags.
          # Since the exact flags aren't documented, we try passing them directly after the script name.
          # Note: If recompile.sh doesn't accept these, this step will fail or compile the default.
          # Based on other tools in the ecosystem, we use rule and symmetry arguments.
          
          ./recompile.sh --rule "$RULE" --symmetry "$SYMM"
        
      - name: Verify Compilation Output
        working-directory: ./apgmera
        run: |
          if [ -f apgluxe ]; then
            echo "Compilation successful. Checking configuration:"
            ./apgluxe --version
            # We can also check the configuration output if it matches the input:
            grep -q "Rule $RULE is correctly configured" output.log || true
          else
            echo "Compilation failed. apgluxe executable not found."
            exit 1
          fi

      - name: Construct apgluxe Run Command
        id: build_command
        run: |
          RULE_INPUT="${{ github.event.inputs.search_rule }}"
          SYMMETRY_INPUT="${{ github.event.inputs.symmetry }}"
          KEY="${{ github.event.inputs.key }}"
          
          # Build the execution command. We pass them again at runtime as well, 
          # as runtime flags usually override compile-time settings.
          COMMAND="./apgluxe --rule ${RULE_INPUT:-b3s23} --symmetry ${SYMMETRY_INPUT:-C1}"
          COMMAND+=" -n ${{ github.event.inputs.haul_size || '20000000' }}"
          COMMAND+=" -p ${{ github.event.inputs.threads || '2' }}"

          if [[ ! -z "$KEY" ]]; then
            COMMAND+=" -k $KEY"
          fi
          
          echo "::set-output name=command::$COMMAND"

      - name: Run apgluxe Search (Grouped Execution)
        run: |
          # Grouping commands in one block ensures 'cd' persists for the execution
          cd apgmera
          
          echo "Executing command: ${{ steps.build_command.outputs.command }}"
          ${{ steps.build_command.outputs.command }}
