name: Compile and Run apgluxe Search from GitLab

# Trigger the workflow on pushes to the main branch or manually
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      search_rule:
        description: 'Conway''s Life Rule (e.g., b3s23)' # Fixed the extra quote here
        required: true
        default: 'b3s23'
      symmetry:
        description: 'Symmetry configuration (e.g., C1, D2_+1)'
        required: true
        default: 'C1'
      key:
        description: 'Your payosha256 key for uploading results (optional)'
        required: false
        default: ''
      haul_size:
        description: 'Number of soups per upload (-n)'
        required: true
        default: '20000000'
      threads:
        description: 'Number of threads to use (-p)'
        required: true
        default: '2'

jobs:
  search:
    # The search requires x86-64 architecture, which standard GitHub runners provide.
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Git
        run: |
          sudo apt-get update
          sudo apt-get install -y git

      - name: Clone apgluxe Repository from GitLab
        run: |
          # Clone the source repository directly from GitLab as per instructions
          git clone https://gitlab.com/apgoucher/apgmera.git
          cd apgmera

      - name: Install Dependencies (Build Essentials)
        run: |
          # Install necessary tools like make and gcc/g++
          sudo apt-get update
          sudo apt-get install -y build-essential
          
      - name: Compile apgluxe
        run: |
          # We are already in the apgmera directory from the previous step
          ./recompile.sh
        
      - name: Verify Compilation Output
        run: |
          # Check for the executable and configuration success
          if [ -f apgluxe ]; then
            echo "Compilation successful. Checking configuration:"
            ./apgluxe --version
          else
            echo "Compilation failed. apgluxe executable not found."
            exit 1
          fi

      - name: Construct apgluxe Run Command
        id: build_command
        run: |
          # Command needs to be run from within the apgmera directory
          COMMAND="./apgluxe"
          
          # 1. Add rule and symmetry
          RULE_INPUT="${{ github.event.inputs.search_rule }}"
          SYMMETRY_INPUT="${{ github.event.inputs.symmetry }}"
          COMMAND+=" --rule ${RULE_INPUT:-b3s23}"
          COMMAND+=" --symmetry ${SYMMETRY_INPUT:-C1}"

          # 2. Add haul size (-n)
          COMMAND+=" -n ${{ github.event.inputs.haul_size || '20000000' }}"
          
          # 3. Add threads (-p)
          COMMAND+=" -p ${{ github.event.inputs.threads || '2' }}"

          # 4. Add key (-k) if provided
          KEY="${{ github.event.inputs.key }}"
          if [[ ! -z "$KEY" ]]; then
            COMMAND+=" -k $KEY"
          fi

          # 5. Safety flags for automated testing:
          COMMAND+=" -t 1" # Disable uploading
          COMMAND+=" -i 1"  # Run for 1 haul and exit
          
          echo "::set-output name=command::$COMMAND"

      - name: Run apgluxe Search
        # Run the command from inside the apgmera directory
        run: |
          cd apgmera
          echo "Executing command: ${{ steps.build_command.outputs.command }}"
          ${{ steps.build_command.outputs.command }}
